# API Endpoints для работы с пользователями

## Описание

В данном разделе отображен набор эндпоинтов для управления пользователями, аутентификации и
авторизации. Все эндпоинты сгруппированы под префиксом /auth, и в них используется система зависимостей FastAPI для
аутентификации пользователей и управления сессиями. Ниже представлен каждый эндпоинт по отдельности.

Этот код реализует набор эндпоинтов с использованием FastAPI для управления пользователями, аутентификации и
авторизации. Все эндпоинты сгруппированы под префиксом `/auth`, и в них используется система зависимостей FastAPI для
аутентификации пользователей и управления сессиями. Давайте разберем каждый эндпоинт по отдельности.

### POST `/auth/login/`

- **Цель**: Аутентифицировать пользователя и вернуть токен доступа.
- **Схема запроса**: `UserLogin` (логин и пароль пользователя).
- **Логика работы**: Сначала происходит валидация пользователя через функцию `validate_auth_user`, которая проверяет,
  существует ли пользователь с таким email и совпадает ли хэшированный пароль. Если проверка проходит успешно,
  генерируется JWT токен с использованием `encode_jwt` из модуля `auth`, в котором в качестве `sub` указывается email
  пользователя.
- **Ответ**: Объект `Token` с токеном доступа и указанием типа токена (`Bearer`).

### POST `/auth/register/`

- **Цель**: Регистрация нового пользователя.
- **Схема запроса**: `UserPasswordCreate` (данные пользователя, включая пароль).
- **Логика работы**: Сначала проверяется, существует ли уже пользователь с таким же email. Если пользователь существует,
  возвращается ошибка `HTTP_400_BAD_REQUEST`. Если нет, хэшируется пароль, и новый пользователь сохраняется в базе
  данных.
- **Ответ**: Базовая информация о пользователе `UserBase`.

### POST `/auth/change-password/`

- **Цель**: Позволяет аутентифицированному пользователю изменить свой пароль.
- **Схема запроса**: `UserPasswordUpdate` (старый и новый пароли).
- **Логика работы**: Проверяется, совпадает ли старый пароль с хэшем в базе. Если нет, возвращается
  ошибка `HTTP_400_BAD_REQUEST`. Если проверка проходит успешно, пароль пользователя обновляется на новый.
- **Ответ**: Сообщение об успешной смене пароля.

### GET `/auth/me/`

- **Цель**: Получить информацию о текущем аутентифицированном пользователе.
- **Логика работы**: Сначала извлекается полезная нагрузка из токена пользователя с помощью `get_current_token_payload`,
  затем
  извлекается сам пользователь через `get_current_auth_user` используя email из токена.
- **Ответ**: Информация о пользователе, включая данные, указанные при регистрации, и дополнительные данные из токена (
  тема, время истечения, время входа).

### PATCH `/auth/me/`

- **Цель**: Обновить информацию о текущем аутентифицированном пользователе.
- **Схема запроса**: `UserBaseUpdate` (данные пользователя для обновления).
- **Логика работы**: Аналогично предыдущему эндпоинту, пользователь идентифицируется через токен. Затем поля
  пользователя
  обновляются на основе предоставленных данных. Важно, что здесь используется динамическое обновление: только поля,
  указанные в запросе и отличающиеся от `None`, будут обновлены.
- **Ответ**: Обновленная информация о пользователе.

### Общие особенности

- **Аутентификация и авторизация**: Для аутентификации используется механизм токенов (`HTTPBearer`), где пользователь
  должен предоставить валидный JWT токен для доступа к защищенным маршрутам.
- **Обработка исключений**: В коде предусмотрена обработка ошибок, например, при неверных учетных данных или если токен
  не валиден, возвращаются соответствующие HTTP ошибки.